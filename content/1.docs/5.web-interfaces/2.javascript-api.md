::callout{type="info"}
В этом разделе описывается JavaScript API, который позволяет веб-интерфейсам взаимодействовать с движком Wudgine.
::

## Введение

Wudgine предоставляет мощный JavaScript API для взаимодействия веб-интерфейсов с движком. Этот API позволяет вам создавать динамические пользовательские интерфейсы, которые могут обмениваться данными с игровой логикой, реагировать на события в игре и управлять игровыми объектами.

## Глобальный объект `engine`

Основной точкой входа в JavaScript API является глобальный объект `engine`, который автоматически доступен в любом веб-интерфейсе, загруженном через компонент `WebUIComponent`.

```javascript
// Пример использования глобального объекта engine
const playerHealth = engine.call('getPlayerHealth');
console.log(`Текущее здоровье игрока: ${playerHealth}`);
```

## Основные методы

### Вызов функций C++

```javascript
/**
 * Вызывает функцию, зарегистрированную в C++
 * @param {string} functionName - Имя функции
 * @param {Object} params - Параметры (опционально)
 * @returns {*} Результат выполнения функции
 */
engine.call(functionName, params);
```

Пример:

```javascript
// Вызов C++ функции без параметров
const playerPosition = engine.call('getPlayerPosition');
console.log(`Позиция игрока: ${playerPosition.x}, ${playerPosition.y}, ${playerPosition.z}`);

// Вызов C++ функции с параметрами
const damageResult = engine.call('applyDamage', {
  targetId: 'enemy_123',
  amount: 50,
  damageType: 'fire'
});

if (damageResult.success) {
  console.log(`Нанесено ${damageResult.actualDamage} урона!`);
}
```

### Регистрация JavaScript функций

```javascript
/**
 * Регистрирует JavaScript функцию для вызова из C++
 * @param {string} functionName - Имя функции
 * @param {Function} callback - Функция обратного вызова
 */
engine.register(functionName, callback);
```

Пример:

```javascript
// Регистрация функции для обновления интерфейса
engine.register('updateHealthUI', (data) => {
  const healthBar = document.getElementById('health-bar');
  const healthText = document.getElementById('health-text');
  
  // Обновление визуального представления
  healthBar.style.width = `${data.healthPercent}%`;
  healthText.textContent = `${data.currentHealth}/${data.maxHealth}`;
  
  // Изменение цвета при низком здоровье
  if (data.healthPercent < 25) {
    healthBar.classList.add('critical');
  } else {
    healthBar.classList.remove('critical');
  }
  
  // Возвращаем результат в C++
  return { success: true };
});
```

## Работа с событиями

### Подписка на события

```javascript
/**
 * Подписывается на событие движка
 * @param {string} eventName - Имя события
 * @param {Function} callback - Функция обратного вызова
 * @returns {number} ID подписки
 */
engine.subscribe(eventName, callback);
```

Пример:

```javascript
// Подписка на событие получения урона
const damageSubscriptionId = engine.subscribe('playerDamaged', (data) => {
  // Создание анимации мигания экрана
  const damageFlash = document.createElement('div');
  damageFlash.className = 'damage-flash';
  document.body.appendChild(damageFlash);
  
  // Удаление эффекта через 500 мс
  setTimeout(() => {
    document.body.removeChild(damageFlash);
  }, 500);
});
```

### Отписка от событий

```javascript
/**
 * Отписывается от события
 * @param {number} subscriptionId - ID подписки
 */
engine.unsubscribe(subscriptionId);
```

### Отправка событий

```javascript
/**
 * Отправляет событие в движок
 * @param {string} eventName - Имя события
 * @param {Object} data - Данные события
 */
engine.emit(eventName, data);
```

## Работа с игровыми данными

### Данные игрока

```javascript
// Получение данных игрока
const playerData = engine.call('getPlayerData');

// Обновление конкретного параметра
engine.call('updatePlayerStat', {
  statName: 'strength',
  newValue: 15
});
```

### Инвентарь

```javascript
// Получение содержимого инвентаря
const inventory = engine.call('getInventory');

// Использование предмета
function useItem(itemId) {
  const result = engine.call('useItem', { itemId });
  
  if (result.success) {
    // Обновление UI
    updateInventoryUI();
  } else {
    // Показ сообщения об ошибке
    showErrorMessage(result.errorMessage);
  }
}
```

## Управление ресурсами

### Загрузка изображений

```javascript
/**
 * Загружает изображение из ресурсов игры
 * @param {string} imagePath - Путь к изображению
 * @returns {Promise<string>} URL изображения
 */
async function loadGameImage(imagePath) {
  const result = await engine.call('loadImage', { path: imagePath });
  return result.imageUrl;
}
```

### Воспроизведение звуков

```javascript
/**
 * Воспроизводит звук
 * @param {string} soundId - ID звука
 * @param {Object} options - Параметры воспроизведения
 */
function playSound(soundId, options = {}) {
  engine.call('playSound', {
    soundId,
    volume: options.volume || 1.0,
    pitch: options.pitch || 1.0,
    loop: options.loop || false
  });
}
```

## Анимации и переходы

### Анимация UI элементов

```javascript
/**
 * Анимирует свойство элемента
 * @param {HTMLElement} element - Элемент для анимации
 * @param {string} property - CSS свойство
 * @param {string|number} targetValue - Целевое значение
 * @param {number} duration - Длительность в мс
 * @returns {Promise} Promise, который разрешается по завершении анимации
 */
function animateProperty(element, property, targetValue, duration = 300) {
  return new Promise(resolve => {
    element.style.transition = `${property} ${duration}ms ease-out`;
    element.style[property] = targetValue;
    
    const onTransitionEnd = () => {
      element.removeEventListener('transitionend', onTransitionEnd);
      resolve();
    };
    
    element.addEventListener('transitionend', onTransitionEnd);
  });
}
```

## Отладка и логирование

```javascript
/**
 * Отправляет сообщение в лог движка
 * @param {string} message - Сообщение
 * @param {string} level - Уровень логирования (debug, info, warning, error)
 */
function log(message, level = 'info') {
  engine.call('log', {
    message,
    level
  });
}
```

## Локализация

```javascript
/**
 * Получает локализованную строку
 * @param {string} key - Ключ строки
 * @param {Object} params - Параметры для подстановки
 * @returns {string} Локализованная строка
 */
function getLocalizedString(key, params = {}) {
  const result = engine.call('getLocalizedString', {
    key,
    params
  });
  
  return result.text;
}
```

## Пример полного компонента: Система инвентаря

```javascript
class InventorySystem {
  constructor() {
    this.inventoryData = null;
    this.draggedItem = null;
    
    // Инициализация
    this.initialize();
  }
  
  async initialize() {
    // Загрузка данных инвентаря
    this.inventoryData = await engine.call('getInventory');
    
    // Создание слотов
    this.createInventorySlots();
    
    // Настройка перетаскивания
    this.setupDragAndDrop();
    
    // Регистрация функции обновления инвентаря
    engine.register('updateInventory', (data) => {
      this.updateInventoryUI(data);
      return { success: true };
    });
  }
  
  createInventorySlots() {
    const container = document.getElementById('inventory-container');
    container.innerHTML = '';
    
    // Создание слотов на основе данных
    for (let i = 0; i < this.inventoryData.slots.length; i++) {
      const slot = document.createElement('div');
      slot.className = 'inventory-slot';
      slot.dataset.slotIndex = i;
      
      // Если в слоте есть предмет, отображаем его
      const itemData = this.inventoryData.slots[i];
      if (itemData) {
        const itemElement = this.createItemElement(itemData);
        slot.appendChild(itemElement);
      }
      
      container.appendChild(slot);
    }
  }
  
  createItemElement(itemData) {
    const item = document.createElement('div');
    item.className = 'inventory-item';
    item.dataset.itemId = itemData.id;
    
    // Изображение предмета
    const img = document.createElement('img');
    img.src = itemData.iconUrl;
    img.alt = itemData.name;
    item.appendChild(img);
    
    return item;
  }
  
  setupDragAndDrop() {
    // Реализация перетаскивания предметов
    // ...
  }
  
  updateInventoryUI(data) {
    this.inventoryData = data;
    // Обновление UI на основе новых данных
    // ...
  }
}
```

## Следующие шаги

::card-group
  :::card{icon="i-lucide-layout" title="UI компоненты" to="/5.web-interfaces/3.ui-components"}
  Изучите готовые UI компоненты для быстрого создания интерфейсов.
  :::
  :::card{icon="i-lucide-code" title="Примеры интерфейсов" to="/5.web-interfaces/4.examples"}
  Посмотрите примеры готовых интерфейсов.
  :::
  :::card{icon="i-lucide-puzzle" title="Плагины" to="/6.plugins/1.overview"}
  Изучите систему плагинов Wudgine.
  :::
::
