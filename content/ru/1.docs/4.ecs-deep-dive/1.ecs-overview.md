::callout{type="info"}
В этом разделе представлен обзор архитектуры Entity-Component-System (ECS) в Wudgine.
::

## Что такое ECS?

Entity-Component-System (ECS) — это архитектурный паттерн, который разделяет логику и данные игры на три основных элемента:

::card-group
  :::card{icon="i-lucide-box" title="Entity (Сущность)"}
  Уникальный идентификатор, представляющий объект в игровом мире. Сущность сама по себе не имеет данных или поведения.
  :::
  :::card{icon="i-lucide-database" title="Component (Компонент)"}
  Контейнер данных, который прикрепляется к сущностям. Компоненты содержат только данные, но не логику.
  :::
  :::card{icon="i-lucide-cog" title="System (Система)"}
  Логика, которая обрабатывает сущности с определенными компонентами. Системы содержат только поведение, но не данные.
  :::
::

## Преимущества ECS

::list{type="success"}
- **Композиция вместо наследования**: Объекты создаются путем комбинирования компонентов
- **Разделение данных и логики**: Улучшает организацию кода и производительность
- **Параллельная обработка**: Системы могут работать параллельно с разными группами компонентов
- **Кэш-эффективность**: Данные компонентов хранятся в непрерывных массивах
- **Гибкость**: Легко добавлять, удалять и изменять поведение объектов
::

## Архитектура ECS в Wudgine

### Сущности (Entities)

В Wudgine сущности представлены как простые идентификаторы:

```cpp
// Создание сущности
Entity player = world.createEntity("Player");

// Проверка валидности сущности
if (player.isValid()) {
    // Работа с сущностью
}

// Уничтожение сущности
world.destroyEntity(player);
```

### Компоненты (Components)

Компоненты — это структуры данных, которые можно прикреплять к сущностям:

```cpp
// Определение компонента
struct TransformComponent {
    Vector3 position = Vector3(0.0f);
    Quaternion rotation = Quaternion::identity();
    Vector3 scale = Vector3(1.0f);
};

// Добавление компонента к сущности
auto& transform = player.addComponent<TransformComponent>();
transform.position = Vector3(0.0f, 1.0f, 0.0f);

// Получение компонента
if (player.hasComponent<TransformComponent>()) {
    auto& transform = player.getComponent<TransformComponent>();
    transform.position.y += 1.0f;
}

// Удаление компонента
player.removeComponent<TransformComponent>();
```

### Системы (Systems)

Системы обрабатывают сущности с определенными компонентами:

```cpp
// Определение системы
class MovementSystem : public System {
public:
    void update(float deltaTime) override {
        // Обработка всех сущностей с компонентами Transform и Velocity
        world.each<TransformComponent, VelocityComponent>(
            [deltaTime](Entity entity, TransformComponent& transform, VelocityComponent& velocity) {
                transform.position += velocity.value * deltaTime;
            }
        );
    }
};

// Регистрация системы
world.registerSystem<MovementSystem>();
```

## Жизненный цикл ECS

![Жизненный цикл ECS](/images/ecs-lifecycle.png)

1. **Инициализация**: Создание мира, регистрация компонентов и систем
2. **Обновление**: Выполнение систем в определенном порядке
3. **Завершение**: Освобождение ресурсов и уничтожение мира

```cpp
// Инициализация
World world;
world.registerComponent<TransformComponent>();
world.registerComponent<VelocityComponent>();
world.registerSystem<MovementSystem>();
world.registerSystem<RenderSystem>();

// Игровой цикл
while (game.isRunning()) {
    float deltaTime = timer.getDeltaTime();
    
    // Обновление всех систем
    world.update(deltaTime);
    
    // Рендеринг
    renderer.render();
}

// Завершение
world.destroy();
```

## Запросы и фильтры

Wudgine предоставляет мощный API для запросов сущностей с определенными компонентами:

::code-group
```cpp [Базовые запросы]
// Получение всех сущностей с компонентами Transform и Renderer
world.each<TransformComponent, MeshRendererComponent>(
    [](Entity entity, TransformComponent& transform, MeshRendererComponent& renderer) {
        // Обработка сущности
    }
);
```

```cpp [Фильтры]
// Получение сущностей с Transform и Renderer, но без Physics
world.each<TransformComponent, MeshRendererComponent>()
    .exclude<PhysicsComponent>()
    .forEach([](Entity entity, TransformComponent& transform, MeshRendererComponent& renderer) {
        // Обработка сущности
    });
```

```cpp [Сортировка]
// Сортировка сущностей по расстоянию от камеры
world.each<TransformComponent, MeshRendererComponent>()
    .sort([cameraPos](const TransformComponent& a, const TransformComponent& b) {
        float distA = Vector3::distance(a.position, cameraPos);
        float distB = Vector3::distance(b.position, cameraPos);
        return distA < distB;
    })
    .forEach([](Entity entity, TransformComponent& transform, MeshRendererComponent& renderer) {
        // Обработка сущностей в отсортированном порядке
    });
```
::

## События и сообщения

Wudgine включает систему событий для коммуникации между системами:

```cpp
// Определение события
struct CollisionEvent {
    Entity entityA;
    Entity entityB;
    Vector3 contactPoint;
    Vector3 contactNormal;
};

// Отправка события
world.emit<CollisionEvent>({player, enemy, contactPoint, contactNormal});

// Подписка на событие
world.subscribe<CollisionEvent>([](const CollisionEvent& event) {
    // Обработка события столкновения
    Debug::log("Collision between {} and {}", 
        event.entityA.getName(), 
        event.entityB.getName());
});
```

## Сериализация

Wudgine поддерживает сериализацию и десериализацию сущностей и компонентов:

```cpp
// Сериализация сущности в JSON
Entity player = world.createEntity("Player");
player.addComponent<TransformComponent>();
player.addComponent<PlayerComponent>();

json playerJson = EntitySerializer::toJson(player);

// Десериализация сущности из JSON
Entity loadedPlayer = EntitySerializer::fromJson(world, playerJson);
```

## Следующие шаги

Теперь, когда вы ознакомились с основами ECS в Wudgine, рекомендуем:

::card-group
  :::card{icon="i-lucide-box" title="Компоненты" to="/ru/4.ecs-deep-dive/2.components"}
  Изучите встроенные компоненты и создание пользовательских компонентов.
  :::
  :::card{icon="i-lucide-cog" title="Системы" to="/ru/4.ecs-deep-dive/3.systems"}
  Узнайте больше о системах и их жизненном цикле.
  :::
::